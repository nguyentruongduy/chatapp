<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <style>
    body, html {
        height: 100%;
        min-height: 100vh;
        font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        background: #18191A;
    }
    .main-flex-wrapper {
        min-height: 100vh;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    .container.mt-4 {
        flex-grow: 1;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        min-height: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .navbar {
        background: #1877f2 !important;
        box-shadow: 0 2px 8px rgba(24,119,242,0.08);
        border-bottom: 1px solid #e3e6ea;
    }
    .navbar .navbar-brand span {
        color: #fff !important;
        font-size: 2rem;
        font-weight: bold;
        letter-spacing: 1px;
    }
    .navbar .navbar-brand img {
        background: #fff;
        border: 2px solid #1877f2;
        border-radius: 50%;
        box-shadow: 0 2px 12px rgba(24,119,242,0.10);
        padding: 6px;
    }
    .navbar .nav-link {
        color: #fff !important;
        font-weight: 500;
        font-size: 1.08rem;
        margin-left: 12px;
        border-radius: 2rem;
        padding: 6px 18px;
        transition: background 0.2s, color 0.2s;
    }
    .navbar .nav-link:hover, .navbar .nav-link:focus {
        background: #1456b8;
        color: #fff !important;
    }
    .navbar .nav-link i {
        color: #fff !important;
        margin-right: 6px;
    }
    .navbar-toggler {
        border-color: #fff !important;
    }
    .navbar-toggler-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255,255,255,1)' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }
    footer {
        margin-top: 0 !important;
        background: #f4f6fa;
        border-top: 1px solid #e3e6ea;
        box-shadow: 0 -2px 8px rgba(24,119,242,0.04);
    }
    footer .container {
        max-width: 1000px;
        margin: 0 auto;
    }
    footer .fw-bold {
        color: #1877f2 !important;
        font-size: 1.2rem;
    }
    footer .text-muted {
        color: #888 !important;
    }
    footer a.text-dark {
        color: #1877f2 !important;
        margin-left: 10px;
        margin-right: 0;
        font-size: 1.3rem;
        transition: color 0.2s;
    }
    footer a.text-dark:hover {
        color: #1456b8 !important;
    }
    footer img {
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(24,119,242,0.08);
        padding: 2px;
    }
    footer .fa-brands, footer .fa {
        color: #1877f2 !important;
    }
    footer .fa-brands:hover, footer .fa:hover {
        color: #1456b8 !important;
    }
    @media (max-width: 900px) {
        .navbar .nav-link i,
        footer .fa-brands,
        footer .fa {
            color: #FFD600 !important;
        }
    }
    .btn-primary, .btn.btn-primary {
        background: #1877f2;
        border: none;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 1.08rem;
        padding: 8px 28px;
        transition: background 0.2s;
    }
    .btn-primary:hover, .btn-primary:focus {
        background: #1456b8;
        color: #fff;
    }
    .btn-outline-primary {
        border-radius: 2rem;
        font-weight: 600;
        font-size: 1.08rem;
        padding: 8px 28px;
        border: 2px solid #1877f2;
        color: #1877f2;
        background: #fff;
        transition: background 0.2s, color 0.2s;
    }
    .btn-outline-primary:hover, .btn-outline-primary:focus {
        background: #1877f2;
        color: #fff;
    }
    </style>
</head>
<body style="background: #18191A;">
    <div class="main-flex-wrapper">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg" style="background: #FFD600;">
            <div class="container" style="max-width: 1000px; margin: 0 auto;">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <img src="/images/LoGo.svg" alt="Logo" width="56" height="56" class="me-3" style="background: #fff; border: 2px solid #FFC107; border-radius: 50%; box-shadow: 0 2px 12px rgba(0,0,0,0.10); padding: 6px;">
                    <span style="font-size: 2rem; font-weight: bold; color: #333; letter-spacing: 1px;">Chat App</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        {{#if user}}
                            <li class="nav-item">
                                <a class="nav-link" href="/chat" style="color: #333;"><i class="fa fa-comments" style="color: #333;"></i> Chat</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#profileModal" style="color: #333;"><i class="fa fa-user-edit" style="color: #333;"></i> Chỉnh sửa profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="logout" style="color: #333;"><i class="fa fa-sign-out-alt" style="color: #333;"></i> Đăng xuất</a>
                            </li>
                        {{else}}
                            <li class="nav-item">
                                <a class="nav-link" href="/login" style="color: #333;">Đăng nhập</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/register" style="color: #333;">Đăng ký</a>
                            </li>
                        {{/if}}
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mt-4 flex-grow-1 d-flex flex-column justify-content-center" style="max-width: 1000px; margin: 0 auto; margin-top: 0 !important; margin-bottom: 0 !important;">
            {{{body}}}
        </div>

        <!-- Footer -->
        <footer class="bg-light text-center text-lg-start border-top shadow-sm">
            <div class="container py-3 d-flex flex-column flex-md-row align-items-center justify-content-between" style="max-width: 1000px; margin: 0 auto;">
                <div class="d-flex align-items-center mb-2 mb-md-0">
                    <img src="/images/LoGo.svg" alt="Logo" width="36" height="36" class="me-2" style="background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 2px;">
                    <span class="fw-bold" style="font-size: 1.2rem; color: #333;">Chat App</span>
                </div>
                <div class="text-muted small mb-2 mb-md-0">&copy; {{year}} Chat App. All rights reserved.</div>
                <div>
                    <a href="#" class="text-dark me-3" title="Facebook"><i class="fa-brands fa-facebook fa-lg"></i></a>
                    <a href="#" class="text-dark me-3" title="Twitter"><i class="fa-brands fa-twitter fa-lg"></i></a>
                    <a href="#" class="text-dark" title="Github"><i class="fa-brands fa-github fa-lg"></i></a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Custom JS -->
    <script src="/js/main.js"></script>
    <script src="/js/chat.js"></script>

    <!-- Modal chỉnh sửa profile -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">Chỉnh sửa Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm" enctype="multipart/form-data">
                        <div class="mb-3 text-center">
                            <img id="profileAvatar" src="{{#if user.avatar}}{{user.avatar}}{{else}}https://via.placeholder.com/80{{/if}}" onerror="this.src='https://via.placeholder.com/80'" class="rounded-circle mb-2" width="80" height="80">
                            <input type="file" id="profileAvatarInput" name="avatar" accept="image/*" class="form-control mt-2">
                        </div>
                        <div class="mb-3">
                            <label for="profileUsername" class="form-label">Tên hiển thị</label>
                            <input type="text" class="form-control" id="profileUsername" name="username" value="{{user.username}}" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Lưu thay đổi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast thông báo -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
        <div id="profileToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="profileToastBody">
                    Cập nhật thành công!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const profileForm = document.getElementById('profileForm');
        const toastEl = document.getElementById('profileToast');
        const toastBody = document.getElementById('profileToastBody');
        let toast;
        if (toastEl) {
            toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        }
        if (profileForm) {
            profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(profileForm);
                let success = false;
                try {
                    // Upload avatar nếu có
                    if (formData.get('avatar') && formData.get('avatar').size > 0) {
                        const res = await fetch('/users/avatar', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data.avatar) {
                            document.getElementById('profileAvatar').src = data.avatar + '?t=' + Date.now();
                            success = true;
                        } else {
                            toastBody.textContent = data.message || 'Lỗi upload avatar';
                            toastEl.classList.remove('bg-success');
                            toastEl.classList.add('bg-danger');
                            toast.show();
                            return;
                        }
                    }
                    // Đổi tên
                    const username = document.getElementById('profileUsername').value;
                    if (username) {
                        const res = await fetch('/users/profile', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username })
                        });
                        const data = await res.json();
                        if (res.ok) {
                            success = true;
                        } else {
                            toastBody.textContent = data.message || 'Lỗi đổi tên';
                            toastEl.classList.remove('bg-success');
                            toastEl.classList.add('bg-danger');
                            toast.show();
                            return;
                        }
                    }
                    if (success) {
                        toastBody.textContent = 'Cập nhật profile thành công!';
                        toastEl.classList.remove('bg-danger');
                        toastEl.classList.add('bg-success');
                        toast.show();
                        setTimeout(() => location.reload(), 1200);
                    }
                } catch (err) {
                    toastBody.textContent = 'Có lỗi xảy ra khi cập nhật profile!';
                    toastEl.classList.remove('bg-success');
                    toastEl.classList.add('bg-danger');
                    toast.show();
                }
            });
        }
        // Tự động cập nhật năm cho footer
        var yearEls = document.querySelectorAll('.footer-year');
        var year = new Date().getFullYear();
        yearEls.forEach(function(el) { el.textContent = year; });
    });
    </script>
</body>
</html> 